<html>

<head>
  <title>3D Boids Project</title>
</head>

<style>
  body {
    margin: 0;
  }

  canvas {
    width: 100%;
    height: 100%;
  }
</style>

<body>
  <link rel="shortcut icon" href="#">


  <style>
    body {
      font-family: Monospace;
      background-color: #000;
      color: #fff;
      margin: 0px;
      overflow: hidden;
    }

    #info {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
    }
  </style>

  <div id="info">
    <p>Autumn 2023 - Intro to CG - 3D Boids</p>
  </div>

  <script type="importmap">
			{
				"imports": {
					"three": "./build/three.module.js",
					"dat.gui": "./node_modules/dat.gui/build/dat.gui.module.js"
				}
			}
		</script>

  <script type="module">
    import * as THREE from 'three';
    import { Boid } from './build/boid.js';
    import { Octree } from './build/octree/octree.js';
    import { Box } from './build/octree/box.js';
    import { BoidSettings } from './build/boid.js';
    import { OrbitControls } from './build/controls/OrbitControls.js';
    import * as dat from 'dat.gui';

    //create the scene
    var scene = new THREE.Scene();
    var ratio = window.innerWidth / window.innerHeight;

    var camera = new THREE.PerspectiveCamera(45, ratio, 0.1, 1000);
    camera.position.set(0, 0, 500);
    camera.lookAt(0, 0, 1);

    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    //#region GUI

    //GUI
    const gui = new dat.GUI();
    const settingsFolder = gui.addFolder('Boid Settings');
    settingsFolder.add(BoidSettings, 'moveSpeed', 0, 10);
    settingsFolder.add(BoidSettings, 'awareness', 0, 100);
    settingsFolder.add(BoidSettings, 'cohesion', 0, 1);
    settingsFolder.add(BoidSettings, 'separation', 0, 1);
    settingsFolder.add(BoidSettings, 'separationAwareness', 0, 50);
    settingsFolder.add(BoidSettings, 'alignment', 0, 1);
    settingsFolder.add(BoidSettings, 'worldSize', 10, 50);
    settingsFolder.open();
    //#endregion

    //create bounds Geometry and add to scene
    const boundsGeometry = new THREE.BoxGeometry(BoidSettings.worldSize, BoidSettings.worldSize, BoidSettings.worldSize);
    var boxMat = new THREE.MeshBasicMaterial();
    boxMat.color = new THREE.Color(0, 0.8, 1);
    boxMat.wireframe = true;
    const boxMesh = new THREE.Mesh(boundsGeometry, boxMat);
    boxMesh.position.set(0, 0, 0);
    scene.add(boxMesh);

    var boids = []; //list of all active boids
    const octree = new Octree(
      new Box(
        -BoidSettings.worldSize * 0.5, -BoidSettings.worldSize * 0.5, -BoidSettings.worldSize * 0.5,
        BoidSettings.worldSize * 0.5, BoidSettings.worldSize * 0.5, BoidSettings.worldSize * 0.5),
      10); //boids octree, used for spacial partitioning and boid-neighbour comparison optimisation
    for (let i = 0; i < 10000; i++) {
      let boid = new Boid();
      boid.createBoid(scene);
      boids.push(boid);
      octree.insert(boid);
    }

    //add light
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(50, 100, 50);
    scene.add(directionalLight);

    //orbit controls
    var controls = new OrbitControls(camera, renderer.domElement);

    var Update = function () {
      renderer.render(scene, camera);
      controls.update();
      const awarenessRange = BoidSettings.awareness;// * BoidSettings.awareness;

      /*do update stuff*/
      for (let i = 0; i < boids.length; i++) {
        boids[i].edgeAvoid();
        let search = new Box(
          boids[i].position.x - awarenessRange,
          boids[i].position.y - awarenessRange,
          boids[i].position.z - awarenessRange,
          awarenessRange * 2,
          awarenessRange * 2,
          awarenessRange * 2);
        let q = octree.query(search);
        //  if (q.length > 0)  
     //   console.log(q.length);
        boids[i].flock(q);
        boids[i].update();
      }

      requestAnimationFrame(Update);
    };

    requestAnimationFrame(Update);

    //this function is called when the window is resized
    var MyResize = function () {
      var width = window.innerWidth;
      var height = window.innerHeight;
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.render(scene, camera);
    };

    //link the resize of the window to the update of the camera
    window.addEventListener('resize', MyResize);
  </script>
</body>

</html>